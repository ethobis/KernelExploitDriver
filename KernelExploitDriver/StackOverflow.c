#include "StackOverflow.h"

NTSTATUS NTAPI
StackOverflowHandler(
	_In_ PIRP pIrp,
	_In_ PIO_STACK_LOCATION pStackLocation
)
{	
	NTSTATUS status = STATUS_SUCCESS;
	PVOID pvUserBuffer = NULL;	
	ULONG ulBufferLength = 0;
	CHAR chKernelBuffer[STACK_SIZE] = { 0, };
	ULONG pvSavedEBP = 0;

	UNREFERENCED_PARAMETER(pIrp);
	
	pvUserBuffer = (PVOID)pStackLocation->Parameters.DeviceIoControl.Type3InputBuffer;

	if (NULL == pvUserBuffer)
	{
		goto _RET;
	}

	ulBufferLength = pStackLocation->Parameters.DeviceIoControl.InputBufferLength;

	__try
	{
		ProbeForRead(pvUserBuffer, sizeof(chKernelBuffer), (ULONG)__alignof(chKernelBuffer));
		//RtlCopyMemory(chKernelBuffer, pvUserBuffer, sizeof(chKernelBuffer));
		__debugbreak();
		__asm
		{
			mov eax, dword ptr[ebp]
			mov pvSavedEBP, eax
		}

		RtlCopyMemory(((PCHAR)pvUserBuffer + ulBufferLength) - 8, &pvSavedEBP, sizeof(ULONG));
		RtlCopyMemory(chKernelBuffer, pvUserBuffer, ulBufferLength);
	}
	__except (EXCEPTION_EXECUTE_HANDLER)
	{
		status = GetExceptionCode();
	}

_RET:
	return status;
}