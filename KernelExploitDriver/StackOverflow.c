#include "StackOverflow.h"

NTSTATUS 
TriggerStackOverflow(
	_In_ PVOID UserBuffer, 
	_In_ SIZE_T Size
)
{
	NTSTATUS Status = STATUS_SUCCESS;
	CHAR KernelBuffer[BUFFER_SIZE] = { 0 };

	__debugbreak();

	__try 
	{
		ProbeForRead(UserBuffer, sizeof(KernelBuffer), (ULONG)__alignof(KernelBuffer));
		RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, Size);
	}
	__except (EXCEPTION_EXECUTE_HANDLER) 
	{
		Status = GetExceptionCode();
	}

	return Status;
}

NTSTATUS
StackOverflowHandler(
	_In_ PIRP pIrp,
	_In_ PIO_STACK_LOCATION pStackLocation
)
{	
	NTSTATUS status = STATUS_SUCCESS;
	PVOID pvUserBuffer = NULL;	
	ULONG ulBufferLength = 0;

	UNREFERENCED_PARAMETER(pIrp);

	ulBufferLength = pStackLocation->Parameters.DeviceIoControl.InputBufferLength;
	pvUserBuffer = (PVOID)pStackLocation->Parameters.DeviceIoControl.Type3InputBuffer;

	if (NULL == pvUserBuffer)
	{
		goto _RET;
	}

	status = TriggerStackOverflow(pvUserBuffer, ulBufferLength);

_RET:
	return status;
}