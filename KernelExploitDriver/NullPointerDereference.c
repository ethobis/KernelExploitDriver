#include "NullPointerDereference.h"

VOID NullPointerDereferenceObjectCallback()
{
	return;
}

NTSTATUS NTAPI
NullPointerDereferenceHandler(
	_In_ PIRP pIrp,
	_In_ PIO_STACK_LOCATION pStackLocation
)
{
	NTSTATUS status = STATUS_SUCCESS;
	PWRITE_WHAT_WHERE pvUserBuffer = NULL;
	ULONG_PTR ulptrUserValue = 0;
	ULONG MagicValue = 0xBAD0B0B0;
	PNULL_POINTER_DEREFERENCE NullPointerDereference = NULL;

	UNREFERENCED_PARAMETER(pIrp);

	pvUserBuffer = (PWRITE_WHAT_WHERE)pStackLocation->Parameters.DeviceIoControl.Type3InputBuffer;

	if (NULL == pvUserBuffer)
	{
		goto _RET;
	}

	__try
	{
		ProbeForRead(pvUserBuffer, sizeof(NULL_POINTER_DEREFERENCE), (ULONG)__alignof(NULL_POINTER_DEREFERENCE));
		NullPointerDereference = (PNULL_POINTER_DEREFERENCE)ExAllocatePool(NonPagedPool, sizeof(NULL_POINTER_DEREFERENCE));

		if (NULL != NullPointerDereference)
		{
			ulptrUserValue = *(PULONG_PTR)pvUserBuffer;

			if (ulptrUserValue == MagicValue)
			{
				NullPointerDereference->ulptrValue = ulptrUserValue;
				NullPointerDereference->Callback = &NullPointerDereferenceObjectCallback;
			}
			else
			{
				if (NULL != NullPointerDereference)
				{
					ExFreePool(NullPointerDereference);
					NullPointerDereference = NULL;
				}
			}

			// NULL인지 확인을 안하면 call null + 4로 Payload를 호출한다.
			//if (NullPointerDereference) 
			//{
			//	NullPointerDereference->Callback();
			//}

			NullPointerDereference->Callback();
		}
	}
	__except (EXCEPTION_EXECUTE_HANDLER)
	{
		status = GetExceptionCode();
	}

_RET:
	return status;
}
