#include "UseAfterFree.h"

PUSE_AFTER_FREE g_pUseAfterFree = NULL;

VOID 
UAFObjectCallback(VOID) { }

NTSTATUS
AllocateUAFObject(VOID)
{
	NTSTATUS status = STATUS_SUCCESS;
	PUSE_AFTER_FREE pUseAfterFree = NULL;

	__try
	{
		pUseAfterFree = (PUSE_AFTER_FREE)ExAllocatePoolWithTag(
			NonPagedPool, 
			sizeof(USE_AFTER_FREE), 
			'uafo'
		);

		if (NULL == pUseAfterFree)
		{
			goto _RET;
		}

		RtlFillMemory((PVOID)pUseAfterFree->chBuffer, sizeof(pUseAfterFree->chBuffer), 0x41);
		pUseAfterFree->chBuffer[sizeof(pUseAfterFree->chBuffer) - 1] = 0x00;
		pUseAfterFree->Callback = &UAFObjectCallback;

		g_pUseAfterFree = pUseAfterFree;

		//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[Allocate Use After Free Object]\n");
		//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] UseAfterFree : %p\n", pUseAfterFree);
		//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] g_UseAfterFree : %p\n", g_pUseAfterFree);
		//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] UseAfterFree->Callback : %p\n\n", pUseAfterFree->Callback);

	}
	__except (EXCEPTION_EXECUTE_HANDLER)
	{
		status = GetExceptionCode();
	}

_RET:
	return status;
}

NTSTATUS
CallUAFObject(VOID)
{
	NTSTATUS status = STATUS_UNSUCCESSFUL;

	__try
	{
		if (g_pUseAfterFree)
		{
			//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[Call Use After Free Object]\n");
			//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] g_UseAfterFree : %p\n", g_pUseAfterFree);
			//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] UseAfterFree->Callback : %p\n\n", g_pUseAfterFree->Callback);

			if (g_pUseAfterFree->Callback)
			{
				g_pUseAfterFree->Callback();
			}

			status = STATUS_SUCCESS;
		}
	}
	__except (EXCEPTION_EXECUTE_HANDLER)
	{
		status = GetExceptionCode();
	}

	return status;
}

NTSTATUS
FreeUAFObject(VOID)
{
	NTSTATUS status = STATUS_UNSUCCESSFUL;

	__try
	{
		if (g_pUseAfterFree)
		{
			//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[Free Use After Free Object]\n");
			//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] Pool Tag : %d\n", STRINGIFY('uafo'));
			//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] Pool Chunk : %p\n\n", g_pUseAfterFree);

			ExFreePoolWithTag((PVOID)g_pUseAfterFree, 'uafo');
			//g_pUseAfterFree = NULL;
			status = STATUS_SUCCESS;
		}
	}
	__except (EXCEPTION_EXECUTE_HANDLER)
	{
		status = GetExceptionCode();
	}

	return status;
}

NTSTATUS
UseAfterFreeHandler(
	_In_ PIRP pIrp,
	_In_ PIO_STACK_LOCATION pStackLocation
)
{
	NTSTATUS status = STATUS_SUCCESS;
	PVOID pvUserBuffer = NULL;
	PUAF_FAKE_OBJECT pKernelFakeObject = NULL;

	UNREFERENCED_PARAMETER(pIrp);

	pvUserBuffer = (PVOID)pStackLocation->Parameters.DeviceIoControl.Type3InputBuffer;

	if (NULL == pvUserBuffer)
	{
		goto _RET;
	}

	__try
	{
		pKernelFakeObject = (PUAF_FAKE_OBJECT)ExAllocatePoolWithTag(
			NonPagedPool,
			sizeof(UAF_FAKE_OBJECT), 
			'uafo'
		);

		if (NULL == pKernelFakeObject)
		{
			goto _RET;
		}

		ProbeForRead((PVOID)pvUserBuffer, sizeof(UAF_FAKE_OBJECT), (ULONG)__alignof(UAF_FAKE_OBJECT));
		RtlCopyMemory((PVOID)pKernelFakeObject, (PVOID)pvUserBuffer, sizeof(UAF_FAKE_OBJECT));
		pKernelFakeObject->chBuffer[sizeof(pKernelFakeObject->chBuffer) - 1] = '\0';

		//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[Fake Use After Free Object]\n");
		//DbgPrintEx(DPFLTR_DEFAULT_ID, DPFLTR_ERROR_LEVEL, "[+] Fake Object : %p\n\n", pKernelFakeObject);
	}
	__except (EXCEPTION_EXECUTE_HANDLER)
	{
		status = GetExceptionCode();
	}

_RET:
	return status;
}